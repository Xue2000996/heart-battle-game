<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¿ƒå°„æ“Šå¤§è³½ - Cassendra vs è–›</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #ffe6f0;
      font-family: 'Comic Sans MS', cursive;
    }
    #scoreboard, #shooterInfo, #ammoDisplay, #currentAmmo {
      position: absolute;
      font-size: 18px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      z-index: 10;
    }
    #scoreboard { top: 10px; left: 10px; }
    #shooterInfo { top: 10px; right: 10px; }
    #ammoDisplay { bottom: 50px; left: 10px; }
    #currentAmmo { bottom: 50px; right: 10px; }
    #endScene {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #fff0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-size: 30px;
      z-index: 999;
    }
    .emoji {
      position: absolute;
      font-size: 30px;
      transition: transform 1s ease-out, opacity 1s ease-out;
      z-index: 1000; /* âœ… è®“ğŸŸåœ¨çµç®—ç•«é¢ä¹‹ä¸Š */
    }
    #day500 {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 80px;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        z-index: 0; /* âœ… è®“å®ƒåœ¨ canvas åº•ä¸‹ */
        pointer-events: none;
        font-family: 'Comic Sans MS', cursive;
    }

  </style>
</head>
<body>
  

  <!-- è³‡è¨Šå€ -->
  <div id="scoreboard">è–›ï¼š0 åˆ†ï½œCassendraï¼š0 åˆ†</div>
  <div id="shooterInfo">ç›®å‰å°„æ“Šè€…ï¼šCassendra</div>
  <div id="ammoDisplay">å‰©é¤˜ â¤ï¸: 5, ğŸ’©: 3</div>
  <div id="currentAmmo">ç›®å‰å½ˆè—¥ï¼šâ¤ï¸</div>
  
  <canvas id="gameCanvas"></canvas>


  <!-- éŸ³æ•ˆè³‡æº -->
  <audio id="heartSound" src="music/heart.mp3"></audio>
  <audio id="poopSound" src="music/poop.mp3"></audio>
  <audio id="selectSound" src="music/select.mp3"></audio>
  <audio id="crySound" src="music/cry.mp3"></audio>
  <audio id="angrySound" src="music/angry.mp3"></audio>

  <!-- â¤ï¸å‘½ä¸­ç‰¹æ•ˆ -->
  <audio id="cassendraHappy" src="music/Voicy_Happy.mp3"></audio>
  <audio id="hsuehLoveYou" src="music/Voicy_Love.mp3"></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶
const bgm = new Audio("music/game.mp3");
const endBgm = new Audio("music/Sneaky Snitch.mp3");
bgm.loop = true;


bgm.play().catch(() => {});

function switchToEndBgm() {
  bgm.pause();
  bgm.currentTime = 0;
  endBgm.play().catch(() => {});
}

    // é ­åƒåœ–ç‰‡è³‡æº
    const headImgs = {
      "Cassendra": new Image(),
      "è–›": new Image(),
      "Cassendra_oops": new Image(),
      "è–›_oops": new Image(),
      "Cassendra_eat": new Image(),
      "è–›_eat": new Image(),
      "Cassendra_loved": new Image(),
      "è–›_loved": new Image(),
      "Cassendra_defense": new Image(),
      "ç‹": new Image(),
      "è»ŠéŠ€å„ª": new Image(),
      "è³´": new Image(),
      "é¾": new Image(),
      "IU": new Image()
    };

    // åœ–ç‰‡ä¾†æº
    headImgs["Cassendra"].src = "pic/cassendra.jpg";
    headImgs["è–›"].src = "pic/hsueh.jpg";
    headImgs["Cassendra_oops"].src = "pic/oops.jpg";
    headImgs["è–›_oops"].src = "pic/oops2.jpg";
    headImgs["Cassendra_eat"].src = "pic/eat.jpg";
    headImgs["è–›_eat"].src = "pic/eat2.jpg";
    headImgs["Cassendra_loved"].src = "pic/loved.jpg";
    headImgs["è–›_loved"].src = "pic/loved2.jpg";
    headImgs["Cassendra_defense"].src = "pic/no poop.png";
    headImgs["ç‹"].src = "pic/ç‹.jpg";
    headImgs["è»ŠéŠ€å„ª"].src = "pic/è»ŠéŠ€å„ª.jpg";
    headImgs["è³´"].src = "pic/è³´.jpg";
    headImgs["é¾"].src = "pic/é¾.jpg";
    headImgs["IU"].src = "pic/IU.jpg";

    // åŠ å…¥èƒŒæ™¯åœ–ç‰‡
document.body.style.backgroundImage = "url('pic/background2.png')";
document.body.style.backgroundSize = "cover";
document.body.style.backgroundRepeat = "no-repeat";
document.body.style.backgroundPosition = "center";


    // éŸ³æ•ˆç‰©ä»¶æ•´ç†
    const sounds = {
heartLaunch: new Audio("music/heart.mp3"),       // ç™¼å°„éŸ³æ•ˆ
heartHit: new Audio("music/Voicy_baby.mp3"),     // å‘½ä¸­æ„›å¿ƒéŸ³æ•ˆ

      poop: document.getElementById("poopSound"),
      select: document.getElementById("selectSound"),
      cry: document.getElementById("crySound"),
      angry: document.getElementById("angrySound"),
      cassendraHappy: document.getElementById("cassendraHappy"),
      hsuehLoveYou: document.getElementById("hsuehLoveYou"),
      cassendraDefense: new Audio("music/Voicy_no.mp3")

    };

    function waitForImages(callback) {
  let imagesToLoad = Object.values(headImgs).length;
  let loadedCount = 0;

  Object.values(headImgs).forEach(img => {
    img.onload = () => {
      loadedCount++;
      if (loadedCount === imagesToLoad) {
        callback();  // æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œç•¢æ‰é–‹å§‹éŠæˆ²
      }
    };
    img.onerror = () => {
      loadedCount++;
      if (loadedCount === imagesToLoad) {
        callback();
      }
    };
  });
}

        // ç©å®¶ç‹€æ…‹
        let player = {
      x: canvas.width / 2,
      y: canvas.height - 100,
      angle: -Math.PI / 2,
      shooter: "Cassendra", // èµ·å§‹ç”± Cassendra å°„æ“Š
    };

    // å½ˆè—¥è¨­å®š
    let ammo = {
      è–›: { heart: 5, poop: 3 },
      Cassendra: { heart: 5, poop: 3 }
    };

    // ç‰¹æ®Šç‹€æ…‹ï¼šCassendra æœ‰ä¸€æ¬¡é˜²ç¦¦å¤§ä¾¿çš„æ©Ÿæœƒ
    let defenseUsed = false;

    let isGameEnded = false; // ğŸ¯ é¿å…é‡è¤‡è§¸ç™¼çµç®—ç•«é¢


    // æ§åˆ¶é …èˆ‡å½ˆé“è³‡æ–™
    let selectedAmmo = "heart";
    let targets = [];
    let projectiles = [];
    let score = { è–›: 0, Cassendra: 0 };
    let round = 0;
    let state = { è–›: "normal", Cassendra: "normal" };

    function createTarget(name, color = "gray") {
      return {
        name,
        x: Math.random() * (canvas.width - 60),
        y: Math.random() * (canvas.height / 2),
        width: 60,
        height: 60,
        dx: (Math.random() - 0.5) * 4,
        dy: (Math.random() - 0.5) * 4,
        isNPC: !(name === "è–›" || name === "Cassendra")
      };
    }

    function startGame() {
      targets = [
        createTarget("Cassendra", "pink"),
        createTarget("è–›", "skyblue"),
        createTarget("ç‹"),
        createTarget("è»ŠéŠ€å„ª"),
        createTarget("è³´"),
        createTarget("é¾"),
        createTarget("IU")
      ];
    }
    function drawTarget(t) {
      let imgKey = t.name;
      if (state[t.name] === "oops") imgKey = `${t.name}_oops`;
      else if (state[t.name] === "loved") imgKey = `${t.name}_loved`;
      else if (state[t.name] === "defense") imgKey = `${t.name}_defense`;

      const img = headImgs[imgKey] || null;
      if (img && img.complete) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(t.x + 30, t.y + 30, 30, 0, Math.PI * 2);
        ctx.clip();
        ctx.drawImage(img, t.x, t.y, 60, 60);
        ctx.restore();
      } else {
        ctx.fillStyle = t.color;
        ctx.fillRect(t.x, t.y, t.width, t.height);
      }

      ctx.fillStyle = "black";
      ctx.font = "16px Arial";
      ctx.fillText(t.name, t.x + 5, t.y + t.height + 20);
    }

    function drawProjectile(p) {
      ctx.font = "28px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(p.type === "heart" ? "â¤ï¸" : "ğŸ’©", p.x, p.y);
    }

    function drawBow() {
        const arrow = "ğŸ¹";
  ctx.font = "48px serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  // å°„å‡ºè§’åº¦æ±ºå®š emoji æ—‹è½‰æ–¹å‘
  const angleDeg = player.angle * 180 / Math.PI;

  ctx.save();
  ctx.translate(player.x, player.y);
  ctx.rotate(player.angle);
  ctx.fillText(arrow, 0, 0);
  ctx.restore();
    }

    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBow();
        ctx.fillStyle = "white";
        ctx.font = "bold 80px Comic Sans MS";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("Day 500 ğŸ’–", canvas.width / 2, canvas.height * 0.5);

        const movementBoundaryY = canvas.height * 0.7; // æ±ºå®šé‚Šç•Œé«˜åº¦

// ç™½è‰²è™›ç·šï¼šåœ–å¡Šçš„ä¸‹é‚Šç•Œ
ctx.strokeStyle = "white";
ctx.lineWidth = 2;
ctx.setLineDash([10, 5]); // 10px å¯¦ç·š, 5px ç©ºæ ¼
ctx.beginPath();
ctx.moveTo(0, movementBoundaryY);
ctx.lineTo(canvas.width, movementBoundaryY);
ctx.stroke();
ctx.setLineDash([]); // æ¸…é™¤è™›ç·šè¨­ç½®ä»¥å…å½±éŸ¿å…¶ä»–ç¹ªåœ–

      // æ›´æ–°ç›®æ¨™ä½ç½®èˆ‡ç¢°æ’
      for (let i = 0; i < targets.length; i++) {
        let t1 = targets[i];
        t1.x += t1.dx;
        t1.y += t1.dy;

        if (t1.y > movementBoundaryY - t1.height) {
  t1.y = movementBoundaryY - t1.height;
  t1.dy *= -1;
}


        if (t1.x < 0 || t1.x > canvas.width - t1.width) t1.dx *= -1;
        if (t1.y < 0) {
        t1.y = 0;
        t1.dy *= -1;
        }

        for (let j = i + 1; j < targets.length; j++) {
          let t2 = targets[j];
          let dx = (t1.x + 30) - (t2.x + 30);
          let dy = (t1.y + 30) - (t2.y + 30);
          let dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 60) {
            let angle = Math.atan2(dy, dx);
            let overlap = 60 - dist;
            let shift = overlap / 2;
            t1.x += Math.cos(angle) * shift;
            t1.y += Math.sin(angle) * shift;
            t2.x -= Math.cos(angle) * shift;
            t2.y -= Math.sin(angle) * shift;

            // é€Ÿåº¦åå½ˆäº¤æ›
            let tmpDx = t1.dx, tmpDy = t1.dy;
            t1.dx = t2.dx; t1.dy = t2.dy;
            t2.dx = tmpDx; t2.dy = tmpDy;
          }
        }

        drawTarget(t1);
      }

      // å½ˆé“è™•ç†ï¼ˆä¿®æ­£ç‰ˆæœ¬ï¼‰
    for (let i = projectiles.length - 1; i >= 0; i--) {
        const p = projectiles[i];
        p.x += p.vx;
        p.y += p.vy;
        drawProjectile(p);

        for (const t of targets) {
            if (
            p.x > t.x && p.x < t.x + t.width &&
            p.y > t.y && p.y < t.y + t.height &&
            t.name === p.target
            ) {
            // ğŸ’– æ„›å¿ƒå‘½ä¸­
            if (p.type === "heart") {
                score[p.shooter]++;
                state[p.target] = "loved";

                if (p.target === "Cassendra") {
                sounds.cassendraHappy.play().catch(() => {});
                } else {
                sounds.hsuehLoveYou.play().catch(() => {});
                }

                setTimeout(() => {
                state[p.target] = "normal";
                }, 1500);
            }

            // ğŸ’© å¤§ä¾¿å‘½ä¸­
            if (p.type === "poop") {
                if (p.target === "Cassendra" && !defenseUsed) {
                defenseUsed = true;
                state[p.target] = "defense";
                sounds.cassendraDefense.play().catch(() => {});
                setTimeout(() => {
                    state[p.target] = "normal";
                }, 1500);
                } else {
                score[p.target]--;
                state[p.target] = "oops";

                const sound = p.target === "è–›" ? sounds.cry : sounds.angry;
                sound.play().catch(() => {});
                setTimeout(() => {
                    state[p.target] = "normal";
                }, 1500);
                }
      }

      // ä¸ç®¡å“ªç¨®å½ˆè—¥ï¼Œåªè¦å‘½ä¸­å°±æ¸…é™¤
      projectiles.splice(i, 1);
      break;
    }
  }
}


      // UI æ›´æ–°
      document.getElementById("scoreboard").innerText =
        `è–›ï¼š${score["è–›"]} åˆ†ï½œCassendraï¼š${score["Cassendra"]} åˆ†`;
      document.getElementById("shooterInfo").innerText = `ç›®å‰å°„æ“Šè€…ï¼š${player.shooter}`;
      const a = ammo[player.shooter];
      document.getElementById("ammoDisplay").innerText = `å‰©é¤˜ â¤ï¸: ${a.heart}, ğŸ’©: ${a.poop}`;
      ctx.fillStyle = "black";
      ctx.textAlign = "left";
      ctx.textBaseline = "bottom";
      ctx.font = "18px Comic Sans MS";  // ğŸ§  æ–°å¢é€™è¡Œï¼Œå›ºå®šå­—é«”å¤§å°
      ctx.fillText("é»æ“Šå°„æ“Š | â†â†’ èª¿æ•´è§’åº¦ | 1: æ„›å¿ƒ 2: å¤§ä¾¿", 20, canvas.height - 20);

      requestAnimationFrame(update);

      // ğŸ¯ è‹¥é›™æ–¹å½ˆè—¥è€—ç›¡ä¸”æ²’æœ‰é£›è¡Œä¸­çš„å½ˆé“ï¼Œå°±çµç®—ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
    const totalAmmo =
    ammo["è–›"].heart + ammo["è–›"].poop +
    ammo["Cassendra"].heart + ammo["Cassendra"].poop;

    // ğŸ’¥ æ–°å¢ï¼šæ¸…é™¤ç•«é¢å¤–æœªå‘½ä¸­ä¸”é‚„å­˜åœ¨çš„å½ˆé“
    projectiles = projectiles.filter(p => p.x >= 0 && p.x <= canvas.width && p.y >= 0 && p.y <= canvas.height);

    if (totalAmmo <= 0 && projectiles.length === 0 && !isGameEnded) {
    isGameEnded = true;
    checkEndGame();
    }


    }

    function nextTurn() {
      round++;
      player.shooter = round % 2 === 0 ? "Cassendra" : "è–›";
    }

    function shootProjectile() {
      const shooter = player.shooter;
      if (ammo[shooter][selectedAmmo] <= 0) return;

      // ç™¼å°„
      ammo[shooter][selectedAmmo]--;
if (selectedAmmo === "heart") {
  sounds.heartLaunch.play().catch(() => {});
} else {
  sounds.poop.play().catch(() => {});
}

      projectiles.push({
        x: player.x,
        y: player.y,
        vx: Math.cos(player.angle- Math.PI / 4) * 6,
        vy: Math.sin(player.angle- Math.PI / 4) * 6,
        shooter,
        target: shooter === "è–›" ? "Cassendra" : "è–›",
        type: selectedAmmo
      });

      nextTurn(); // å³ä½¿æ²’å‘½ä¸­ä¹Ÿæ›äºº
    }

    function checkEndGame() {
        console.log("âœ… checkEndGame() è¢«å‘¼å«äº†");

      const total =
        ammo["è–›"].heart + ammo["è–›"].poop +
        ammo["Cassendra"].heart + ammo["Cassendra"].poop;

      if (total <= 0 && projectiles.length === 0) {
        switchToEndBgm();  // åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚
        setTimeout(() => {

            const winner =
                score["è–›"] > score["Cassendra"] ? "è–›" :
                score["Cassendra"] > score["è–›"] ? "Cassendra" : "å¹³æ‰‹";


          const container = document.createElement("div");
          
            container.id = "endScene";
            container.style.position = "absolute";
            container.style.top = "0";
            container.style.left = "0";
            container.style.width = "100%";
            container.style.height = "100%";
            container.style.background = "white";
            container.style.color = "black";
            container.style.display = "flex";
            container.style.flexDirection = "column";
            container.style.justifyContent = "center";
            container.style.alignItems = "center";
            container.style.fontSize = "40px";
            container.style.zIndex = "999";

          console.log("ğŸ† å‹åˆ©è€…æ˜¯:", winner);


const winnerText = document.createElement("div");
winnerText.innerText = winner === "å¹³æ‰‹" ? "å¹³æ‰‹ï¼" : `${winner} å‹åˆ©ï¼`;
winnerText.style.marginBottom = "30px";  // å¢åŠ æ–‡å­—èˆ‡åœ–ç‰‡é–“è·
winnerText.style.fontSize = "40px";
container.appendChild(winnerText);


// ğŸ–¼ï¸ å»ºç«‹å‹•ç•«åœ–åƒä¸¦è¼ªæ’­åœ–ç‰‡
const eatAnimation = document.createElement("img");
eatAnimation.id = "eatAnimation";
eatAnimation.style.display = "block";
eatAnimation.style.position = "relative";


let frames = [];
if (winner === "è–›") {
  frames = ["pic/O2.jpg", "pic/C2.jpg"];
  eatAnimation.style.width = "600px";
} else if (winner === "Cassendra") {
  frames = ["pic/O1.jpg", "pic/C1.jpg"];
  eatAnimation.style.width = "800px"
} else {
  frames = ["pic/both.jpg"];
  eatAnimation.style.width = "1000px"
}
eatAnimation.style.marginTop = "10px"; // èˆ‡æ–‡å­—æ‹‰é–‹è·é›¢
container.appendChild(eatAnimation);
document.body.appendChild(container);  // âœ… è¦åŠ åˆ°é é¢ä¸­æ‰æœƒé¡¯ç¤º

let index = 0;
eatAnimation.src = frames[0];

if (frames.length > 1) {
  animationInterval = setInterval(() => {
    eatAnimation.src = frames[index % frames.length];
    index++;
  }, 500);
}


          // æ”¾é­šå‹•ç•«
          setInterval(() => {
            const emoji = document.createElement("div");
            emoji.className = "emoji";
            emoji.innerText = "ğŸŸ";
            if (winner !== "å¹³æ‰‹") {
                setInterval(() => {
                    const emoji = document.createElement("div");
                    emoji.className = "emoji";
                    emoji.innerText = "ğŸŸ";

                    if (winner === "è–›") {
                    emoji.style.left = "48%";
                    emoji.style.top = "67%";
                    } else if (winner === "Cassendra") {
                    emoji.style.left = "43%";
                    emoji.style.top = "62%";
                    }

                    document.body.appendChild(emoji);

                    setTimeout(() => {
                    emoji.style.transform = "scale(0.1) translateY(50px)";
                    emoji.style.opacity = "0";
                    }, 100);
                    setTimeout(() => emoji.remove(), 1500);
                }, 400);
                }

            document.body.appendChild(emoji);

            setTimeout(() => {
              emoji.style.transform = "scale(0.1) translateY(50px)";
              emoji.style.opacity = "0";
            }, 100);
            setTimeout(() => emoji.remove(), 1500);
          }, 400);
        }, 1000);
      }
    }

    canvas.addEventListener("click", () => {
      if (bgm.paused) {
        bgm.play().catch(() => {});
      }
      shootProjectile();
      checkEndGame();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") player.angle -= 0.1;
      if (e.key === "ArrowRight") player.angle += 0.1;
      if (e.key === "1") {
        selectedAmmo = "heart";
        document.getElementById("currentAmmo").innerText = "ç›®å‰å½ˆè—¥ï¼šâ¤ï¸";
        sounds.select.play().catch(() => {});
      }
      if (e.key === "2") {
        selectedAmmo = "poop";
        document.getElementById("currentAmmo").innerText = "ç›®å‰å½ˆè—¥ï¼šğŸ’©";
        sounds.select.play().catch(() => {});
      }
    });

waitForImages(() => {
  sounds.cassendraHappy.volume = 0.15;
  bgm.volume = 0.2;
  sounds.cry.volume = 1.0;
  sounds.angry.volume = 0.5;
  sounds.cassendraDefense.volume = 0.6;
  sounds.heartHit.volume=0.7;
  sounds.heartLaunch.volume=0.5;
  sounds.hsuehLoveYou.volume=0.7;
  sounds.poop.volume=0.3;
  sounds.select.volume=0.8;

  startGame();
  update();
});


let animationInterval;


// åœæ­¢å‹•ç•«ï¼ˆå¦‚æœä½ æƒ³åŠ å…¥æ‰‹å‹•åœæ­¢ç”¨ï¼‰
function stopFeedingAnimation() {
  clearInterval(animationInterval);
  eatAnimation.style.display = "none";
}

  </script>
</body>
</html>
